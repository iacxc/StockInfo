#!/usr/bin/python -O

from bottle import Bottle, run, request
from collections import namedtuple
import DBUtils

RowType = namedtuple("RowType", ["code", "date", "fund_in", "fund_out",
                                 "fund_net", "fund_per", "percent", "inc_p"])
app = Bottle()

def f_fund(fund, digits=2):
    """ decrate the fund, if positive, use green; negative, use red
    """
    if fund is None:
        return ""

    if fund > 0:
        return "<font color=green>{0:.{1}f}</font>".format(fund, digits)
    elif fund < 0:
        return "<font color=red>{0:.{1}f}</font>".format(fund, digits)
    else:
        return "{0:.{1}f}".format(fund, digits)


@app.route("/")
def hello():
    return "Hello"


@app.route("/stock_fund")
def stock_fund():
    limit = request.query.limit or '30'
    db = DBUtils.get_db()

    h_tables = []
    cursor = db.cursor()
    for code in DBUtils.get_codes(db):

        querystr = """SELECT *
FROM
    (SELECT code, date, fund_in, fund_out, fund_net, fund_per,
	        fund_net / value as percent, inc_p
     FROM funds
     WHERE code = ?
     ORDER BY date DESC LIMIT {1})
ORDER BY date""".format(",".join(RowType._fields), limit)

        cursor.execute(querystr, (code,))

        #table header
        tlines = ["""<tr bgcolor="#a0a0a0">
    <th nowrap>{0}</th>
    <th nowrap>Date</th>
    <th nowrap>Fund In</th>
    <th nowrap>Fund Out</th>
    <th nowrap>Fund Net</th>
    <th nowrap>Total %</th>
    <th nowrap>Current %</th>
    <th nowrap>Increase %</th>
</tr>""".format(code)]

        total_funds = 0
        total_percent = 0
        total_increase = 0

        rows = [RowType(*row) for row in cursor.fetchall()]

        firstrow = True
        for row in rows:
            row = RowType(*row)
            tlines.append("""<tr bgcolor="#eeeeee">
    {rowheader}
    <td>{date}</td>
    <td align="right">{fund_in:.1f}</td>
    <td align="right">{fund_out:.1f}</td>
    <td align="right">{fund_net}</td>
    <td align="right" nowrap><b>{percent}</b> %</td>
    <td align="right" nowrap><b>{fund_per}</b> %</td>
    <td align="right"><b>{inc_p}</b> %</td>
</tr>""".format(rowheader="<td rowspan=%d>&nbsp;</td>" % (len(rows))
                                                   if firstrow else "",
                date=row.date,
                fund_in=row.fund_in,
                fund_out=row.fund_out,
                fund_net=f_fund(row.fund_net),
                percent=f_fund(row.percent, 3),
                fund_per=f_fund(row.fund_per),
                inc_p=f_fund(row.inc_p),
                ))
            total_funds += row.fund_net
            total_percent += row.percent
            total_increase += row.inc_p

            firstrow = False

        #table footer
        tlines.append("""<tr bgcolor="#eeeeee">
    <td></td>
    <td align="center">Total</td>
    <td></td>
    <td></td>
    <td align="right">{0}</td>
    <td align="right"><b>{1}</b> %</td>
    <td></td>
    <td align="right"><b>{2}</b> %</td>
</tr>""".format(f_fund(total_funds),
                f_fund(total_percent, 3),
                f_fund(total_increase), ))

        h_tables.append("""<br/>
<table border=0 cellspacing="1" cellpadding="5">
<col width="70">
<col width="100">
<col width="70">
<col width="80">
<col width="80">
<col width="70">
<col width="80">
<col width="90">
{tbody}
</table>
<br/>""".format(tbody="\n".join(tlines)))

    html = """<html>
<title>Stock Funds</title>
<style type="text/css">
body {{
    font-family: Aria, Helvetica;
}}
</style>
<body>
{0}
</body>
</html>
""".format("\n".join(h_tables))

    return html


run(app, host="localhost", port=8088, debug=True)
